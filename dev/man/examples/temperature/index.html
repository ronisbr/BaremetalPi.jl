<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Temperature · BaremetalPi</title><script data-outdated-warner src="../../../assets/warner.js"></script><link rel="canonical" href="https://ronisbr.github.io/BaremetalPi.jl/stable/man/examples/temperature/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">BaremetalPi</a></span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../gpio/">GPIO</a></li><li><a class="tocitem" href="../../spi/">SPI</a></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../led/">LED</a></li><li class="is-active"><a class="tocitem" href>Temperature</a></li></ul></li><li><a class="tocitem" href="../../../lib/library/">Library</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Temperature</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Temperature</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/ronisbr/BaremetalPi.jl/blob/master/docs/src/man/examples/temperature.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Temperature"><a class="docs-heading-anchor" href="#Temperature">Temperature</a><a id="Temperature-1"></a><a class="docs-heading-anchor-permalink" href="#Temperature" title="Permalink"></a></h1><p>This example shows how to use <strong>BaremetalPi.jl</strong> together with a AD converter MCP3008 and a 103 thermistor to read the ambient temperature. The connections between the components are shown in the following figure:</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>We are using the Raspberry Pi Zero W as an example. You <strong>must</strong> modify it according to your model.</p></div></div><img src="../../../assets/Schematic_example_temperature.png" width="85%"/><p>The MCP3008 is a 8-channel 10-bit analog to digital converted that communicates using the SPI interface. Thus, the first thing is to make sure that SPI is enabled in your Linux distribution so that the devices <code>/dev/spidevX.Y</code> exists (<code>X</code> and <code>Y</code> are integers related to the SPI numbering). Please, check the manual of your distribution for more information.</p><p>After the connection, we need to start the SPI interface in <strong>BaremetalPi.jl</strong>. Here, we consider that the device in which the MCP3008 was connected is called <code>/dev/spidev0.0</code>.</p><pre><code class="language-julia hljs">using BaremetalPi

init_spi(&quot;/dev/spidev0.0&quot;, max_speed_hz = 1000)</code></pre><p>Notice that we limit the sampling speed to 1000 Hz to improve the signal-to-noise ratio of the AD conversion as per MCP3008 datasheet.</p><p>To acquire a new measurement, we need to perform a full-duplex SPI transfer. Three bytes must be sent to the device: <code>0x01 0x80 0x00</code>, which asks for a new measurement of the channel 0. For more information about how MCP3008 works, please, see the datasheet. This full-duplex transfer can be accomplished using <strong>BaremetalPi.jl</strong> as follows:</p><pre><code class="language-julia hljs">tx_buf = [0x01, 0x80, 0x00]
rx_buf = zeros(UInt8, 3)

ret = spi_transfer!(1, tx_buf, rx_buf)</code></pre><p><code>ret</code> must be 3 indicating that the device returned 3 bytes. The 10-bit AD measurement is then stored in <code>rx_buf[2:3]</code>. The conversion to voltage is performed as follows:</p><pre><code class="language-julia hljs">V = ( (UInt16(rx_buf[2] &amp; 3) &lt;&lt; 8) + rx_buf[3] )*3.3/1024</code></pre><p>Now, we need to obtain the resistance of the thermistor using the equation of the voltage divider:</p><pre><code class="language-julia hljs">R_div = 10_000         # ............. Resistor value at the voltage divider [Ω]
th_R = R_div*(3.3/V - 1)</code></pre><p>Finally, using the relationship between resistance and temperature for the selected thermistor, we can get a measurement of the ambient temperature:</p><pre><code class="language-julia hljs">th_β  = 3380           # ................ Beta coefficient of the thermistor [K]
th_R₀ = 10_000         # ............. Reference thermistor resistance at T₀ [Ω]
th_T₀ = 25             # ....... Reference temperature T₀ of the thermistor [°C]

T = 1/( log(th_R / th_R₀)/th_β + 1/(th_T₀ + 273.15) ) - 273.15</code></pre><p>The following code prints the temperature every 5s:</p><pre><code class="language-julia hljs">using Dates
using Printf
using BaremetalPi

################################################################################
#                                Configuration
################################################################################

const R_div = 10_000   # ............. Resistor value at the voltage divider [Ω]
const th_β  = 3380     # ................ Beta coefficient of the thermistor [K]
const th_R₀ = 10_000   # ............. Reference thermistor resistance at T₀ [Ω]
const th_T₀ = 25       # ....... Reference temperature T₀ of the thermistor [°C]

################################################################################
#                                  Functions
################################################################################

function acquire_temperature()
    # Acquire the AD measurement
    # ==========================================================================

    tx_buf = [0x01, 0x80, 0x00]
    rx_buf = zeros(UInt8, 3)
    V      = 0

    ret = spi_transfer!(1, tx_buf, rx_buf)

    if ret != 3
        @warn(&quot;The data received from MCP3008 does not have 3 bytes.&quot;)
        return NaN
    end

    # AD measurement.
    V = ( (UInt16(rx_buf[2] &amp; 3) &lt;&lt; 8) + rx_buf[3] )*3.3/1024

    if V == 0
        @warn(&quot;The MCP3008 measured 0V.&quot;)
        return NaN
    end

    if V &gt; 3.25
        @warn(&quot;The MCP3008 measured a too high voltage (&gt; 3.25V).&quot;)
        return NaN
    end

    # Convert the measurement to temperature
    # ==========================================================================

    th_R = R_div*(3.3/V - 1)
    T    = 1/( log(th_R / th_R₀)/th_β + 1/(th_T₀ + 273.15) ) - 273.15

    return T
end

function run()
    # Let&#39;s sample at 1kHz to improve the accuracy of MCP3008.
    init_spi(&quot;/dev/spidev0.0&quot;, max_speed_hz = 1000)

    while true
        T = acquire_temperature()

        if !isnan(T)
            @printf(&quot;%-30s %3.2f\n&quot;, string(now()), T)
        else
            println(&quot;[ERROR] Problem when acquiring AD measurement.&quot;)
        end
        sleep(5)
    end
end

run()</code></pre><p><strong>Result:</strong></p><pre><code class="nohighlight hljs">2020-06-14T19:36:40.564        22.65
2020-06-14T19:36:46.235        22.65
2020-06-14T19:36:51.264        22.65
2020-06-14T19:36:56.286        22.65
2020-06-14T19:37:01.32         22.65
2020-06-14T19:37:06.354        22.65
2020-06-14T19:37:11.381        22.65
2020-06-14T19:37:16.415        22.65
2020-06-14T19:37:21.443        22.65
2020-06-14T19:37:26.465        23.57   -&gt; I placed my finger on the thermistor.
2020-06-14T19:37:31.497        23.57
2020-06-14T19:37:36.525        23.16
2020-06-14T19:37:41.547        22.86
2020-06-14T19:37:46.581        22.76</code></pre><div class="admonition is-info"><header class="admonition-header">Info</header><div class="admonition-body"><p>To improve the accuracy, measure the resistance of the voltage divider resistor and update the constant <code>R_div</code>. Furthermore, check the β of your thermistor and update the value in the constant <code>th_β</code>.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../led/">« LED</a><a class="docs-footer-nextpage" href="../../../lib/library/">Library »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.15 on <span class="colophon-date" title="Sunday 3 April 2022 18:54">Sunday 3 April 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
